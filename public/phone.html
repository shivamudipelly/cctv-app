<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phone CCTV Sender</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: 'Roboto', sans-serif;
    }

    #localVideo {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 1;
      background: #000;
    }

    #status {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 500;
      z-index: 2;
    }

    #startBtn {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 32px;
      font-size: 18px;
      background: #2196F3;
      color: #fff;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      z-index: 2;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    #startBtn:hover {
      transform: translateX(-50%) scale(1.05);
      box-shadow: 0 0 15px #2196F3;
    }

    #startBtn:disabled {
      background: #1565C0;
      cursor: not-allowed;
      box-shadow: none;
    }
  </style>
</head>

<body>

  <div id="status">Status: Loading...</div>
  <video id="localVideo" autoplay playsinline muted></video>
  <button id="startBtn">🎥 START STREAMING</button>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/simple-peer@9.11.0/simplepeer.min.js"></script>
  <script>
    const video = document.getElementById('localVideo');
    const startBtn = document.getElementById('startBtn');
    const statusEl = document.getElementById('status');

    const socket = io();
    let peer;
    let stream;

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: 1280, height: 720 },
          audio: false
        });
        video.srcObject = stream;
        statusEl.textContent = '✅ Camera Ready';
      } catch (err) {
        statusEl.textContent = '❌ Camera Error';
        console.error(err);
      }
    }

    startBtn.onclick = async () => {
      if (!stream) await startCamera();
      if (!stream) return;

      startBtn.disabled = true;
      statusEl.textContent = '🔌 Connecting to server...';

      socket.emit('initiate');

      socket.on('ready', () => {
        statusEl.textContent = '⏳ Waiting for monitor to connect...';
      });

      socket.on('startCall', async ({ monitorId }) => {
        statusEl.textContent = '📡 Starting WebRTC connection...';

        peer = new SimplePeer({
          initiator: true,
          stream: stream,
          trickle: false
        });

        peer.on('signal', data => {
          socket.emit('signal', { to: monitorId, signal: data });
        });

        peer.on('connect', () => {
          statusEl.textContent = '✅ LIVE STREAMING TO MONITOR';
        });

        peer.on('error', err => {
          statusEl.textContent = '❌ WebRTC Error';
          console.error(err);
        });
      });

      socket.on('signal', data => {
        if (peer) peer.signal(data.signal);
      });
    };

    // Start camera automatically on page load
    startCamera();
  </script>

</body>

</html>